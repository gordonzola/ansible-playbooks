---
- hosts: hypervisors
  remote_user: root
  vars_prompt:
    - name: "host"
      prompt: "what is the container domain to delete?"
      private: no

  tasks:

    - name: Create global host
      add_host:
        name: global
        global_host: "{{ host }}"

    - name: Get vault data
      set_fact:
        host_vars: "{{ hostvars | get(host) }}"

    - name: Get CTID
      set_fact:
        ctid: "{{ host_vars['ctid'] }}"

    - name: Get firewall facts
      set_fact:
        firewall_ip: "10.0.{{ hostvars[node].vlan }}.{{ hostvars[node].ctid }}"
        firewall_public_ip: "{{ hostvars[node].public_ip }}"
        firewall_gateway: "{{ hostvars[node].gateway }}"
        firewall_public_ip6: "{{ hostvars[node].public_ip6 }}"
        firewall_gateway6: "{{ hostvars[node].gateway6 }}"
        firewall_mac: "{{ hostvars[node].mac }}"
        firewall_ctid: "{{ hostvars[node].ctid }}"
      when: hostvars[node].role == 'firewall'
      loop: "{{ groups['containers'] }}"
      loop_control:
        loop_var: node

    - name: Get reverse proxy facts
      set_fact:
        reverse_proxy_ip: "10.0.{{ hostvars[node].vlan }}.{{ hostvars[node].ctid }}"
        reverse_proxy_ctid: "{{ hostvars[node].ctid }}"
      when: hostvars[node].role == 'http'
      loop: "{{ groups['containers'] }}"
      loop_control:
        loop_var: node

    - name: Get mailinabox facts
      set_fact:
        miab_ip: "10.0.{{ hostvars[node].vlan }}.{{ hostvars[node].ctid }}"
        miab_ctid: "{{ hostvars[node].ctid }}"
        miab_domain: "{{ node }}"
      when: hostvars[node].role == 'miab'
      loop: "{{ groups['containers'] }}"
      loop_control:
        loop_var: node

    - name: Check if CT still exists
      shell: "ls /etc/pve/nodes/{{ ansible_hostname }}/lxc/{{ ctid }}.conf | wc -l"
      register: config_exists

    - name: Get status of container
      command: "pct status {{ ctid }}"
      register: ct_status
      when: config_exists.stdout == '1'

    - name: Remove DNS entries
      command: >
        curl -X POST --user "me@{{ miab_domain }}:{{ miab_pw }}"
        -d "email=system@{{ host }}"
        "https://{{ miab_domain }}/admin/mail/users/remove"
      ignore_errors: yes
      when: host_vars.role not in ('http', 'firewall', 'miab')

    # - name: Reload NFS mountpoints
    #   command: "pct exec {{ reverse_proxy_ctid }} umount /var/www/nginx/{{ host }}/docroot"
    #   ignore_errors: yes
    #   when: "host_vars.role not in ('http', 'miab', 'firewall')"

    # - name: Remove NFS mountpoints
    #   file:
    #     path: "/rpool/data/encrypted-{{ reverse_proxy_ctid }}/subvol-{{ reverse_proxy_ctid }}-disk-0/var/www/nginx/{{ host }}/docroot"
    #     state: absent
    #   when: "host_vars.role not in ('http', 'miab', 'firewall')"

    # - name: Reload NFS mountpoints
    #   command: "pct exec {{ reverse_proxy_ctid }} umount /home/user-data/ssl"
    #   ignore_errors: yes
    #   when: "host_vars.role == 'miab'"

    # - name: Unmount NFS mountpoint
    #   lineinfile:
    #     path: "/rpool/data/encrypted-{{ reverse_proxy_ctid }}/subvol-{{ reverse_proxy_ctid }}-disk-0/etc/fstab"
    #     state: absent
    #     regexp: '^10.0.{{ host_vars.vlan }}.{{ ctid }}'

    # - name: Unmount NFS mountpoint
    #   lineinfile:
    #     path: "/rpool/data/encrypted-{{ reverse_proxy_ctid }}/subvol-{{ reverse_proxy_ctid }}-disk-0/etc/fstab"
    #     state: absent
    #     regexp: '^# {{ host }}'
    #

    - name: Check if front CT still exists
      shell: "ls /etc/pve/nodes/{{ ansible_hostname }}/lxc/{{ reverse_proxy_ctid }}.conf | wc -l"
      register: front_config_exists

    - name: Get status of front container
      command: "pct status {{ reverse_proxy_ctid }}"
      register: front_ct_status
      when: "front_config_exists.stdout == '1' and host_vars.role != 'http'"

    - name: Stop nginx on front container
      command: "pct exec {{ reverse_proxy_ctid }} /etc/init.d/nginx stop"
      ignore_errors: true
      when: "front_config_exists.stdout == '1' and host_vars.role != 'http' and 'running' in front_ct_status.stdout"

    - name: Remove nginx vhost
      file:
        path: "/rpool/data/encrypted-{{ reverse_proxy_ctid }}/subvol-{{ reverse_proxy_ctid }}-disk-0/etc/nginx/conf.d/10.{{ host }}.conf"
        state: absent
      when: "front_config_exists.stdout == '1' and host_vars.role != 'http'"

    - name: Stop front container
      command: "pct stop {{ reverse_proxy_ctid }}"
      when: "front_config_exists.stdout == '1' and host_vars.role != 'http' and 'running' in front_ct_status.stdout"

    - name: Unmount NFS share
      command: "umount /mnt/pve/nfs-{{ ctid }}"
      ignore_errors: yes
      when: "host_vars.role not in ('http', 'miab', 'firewall')"

    - name: Remove mountpoint from front
      command: "sed -i '#/mnt/pve/nfs-{{ ctid }}#d' /etc/pve/lxc/{{ reverse_proxy_ctid }}.conf"
      # lineinfile:
      #   path: "/etc/pve/lxc/{{ reverse_proxy_ctid }}.conf"
      #   regexp: "/mnt/pve/nfs-{{ ctid }}"
      #   state: absent

    - name: Delete NFS share
      command: "pvesm remove nfs-{{ ctid }}"
      ignore_errors: yes
      when: "host_vars.role not in ('http', 'miab', 'firewall')"

    - name: Unmount NFS share (ssl)
      command: "umount /mnt/pve/nfs-ssl"
      ignore_errors: yes
      when: "host_vars.role == 'miab'"

    - name: Delete NFS share (ssl)
      command: "pvesm remove nfs-ssl"
      ignore_errors: yes
      when: "host_vars.role == 'miab'"

    - name: Stop NFS server
      command: "pct exec {{ ctid }} /etc/init.d/nfs stop"
      ignore_errors: yes
      when: "config_exists.stdout == '1' and 'status: running' in ct_status.stdout"

    - name: Stop NFS server
      command: "pct exec {{ ctid }} systemctl stop nfs-kernel-server"
      ignore_errors: yes
      when: "config_exists.stdout == '1' and 'status: running' in ct_status.stdout"

    - name: Stop container
      command: "pct stop {{ ctid }}"
      when: "config_exists.stdout == '1' and 'status: running' in ct_status.stdout"

    - name: Start back front container
      command: "pct start {{ reverse_proxy_ctid }}"
      when: "front_config_exists.stdout == '1' and host_vars.role != 'http' and 'running' in front_ct_status.stdout"

    # - name: Umount public dir
    #   debug:
    #     msg: TODO

    # - name: Umount certs dir
    #   command: "umount /var/containers/http/home/user-data/ssl"
    #   ignore_errors: true
    #   when: host_vars.role in ('http', 'miab')

    # - name: Umount challenges dir
    #   command: "umount /var/containers/http/var/letsencrypt/docroot"
    #   ignore_errors: true
    #   when: host_vars.role in ('http', 'miab')

    - name: Delete container
      command:
        cmd: "pct destroy {{ ctid }}"
        removes: "/etc/pve/nodes/{{ ansible_hostname }}/lxc/{{ ctid }}.conf"

    - name: Remove cron tasks
      cron:
        name: "{{ item }}"
        state: absent
      loop:
        - "Backups for {{ host }}"
        - "Snapshot for {{ host }}"
        - "Snapshot prune for {{ host }}"

    - name: Check if storage still exists
      shell: "pvesm status | grep root-{{ ctid }} | wc -l"
      register: storage_exists

    - name: Remove storage
      command: "pvesm remove root-{{ ctid }}"
      when: storage_exists.stdout == '1'

    - name: Remove ZFS volume
      command:
        cmd: "zfs destroy -r {{ host_vars['pool'] }}"
        removes: "/rpool/data/encrypted-{{ ctid }}"

    # - name: Remove firewall rules
    #   file:
    #     path: "/etc/pve/firewall/{{ ctid }}.fw"
    #     state: absent

    # TODO: fix this for firewall
    # - name: Check if VLAN is unused
    #   shell: "grep -c 'tag-{{ host_vars['vlan'] }}' /etc/pve/lxc/* | grep -v ':0$' | echo -n"
    #   register: vlan_uses

    # - name: Shutdown VLAN
    #   command: "ifdown vmbr1.{{ host_vars['vlan'] }}"
    #   when: "vlan_uses.stdout|int >= 1"

    # - name: Remove VLAN
    #   file:
    #     path: "/etc/network/interfaces.d/vmbr1.{{ host_vars['vlan'] }}.conf"
    #     state: absent
    #   when: "vlan_uses.stdout|int >= 1"

    # - name: Remove ports redirections
    #   shell: "grep -R {{ host }} /etc/network/ports.d/post-down | awk -F '{ print $1 }' | xargs bash; :"

    # - name: Remove ports redirections configs
    #   shell: "grep -R {{ host }} /etc/network/ports.d/ | awk -F '{ print $1 }' | xargs rm; :"

# - name: Remove backup account
#   hosts: backup
#   tasks:
#     - name: TODO
#       meta: noop

- name: Remove volume info in vault
  hosts: 127.0.0.1
  connection: local
  tasks:
    # - name: Test
    #   debug:
    #     msg: "hostname: {{ hostvars['new_host'] | hostvars_tojson }}"
    - name: Call remove_host.py
      # command: "./remove_host.py '{{ ctid }}'"
      file:
        path: "./host_vars/{{ hostvars['global'].global_host }}"
...


