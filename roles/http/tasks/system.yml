---
- name: Install nginx
  apk:
    name: nginx

- name: Install bash
  apk:
    name: bash
- name: Install openssl
  apk:
    name: openssl
- name: Hardening nginx
  include_role:
    name: dev-sec.nginx-hardening

- name: Create docroot
  file:
    path: /srv/www/default
    state: directory
    owner: nginx
    group: nginx

- name: Create default index page
  copy:
    src: "files/99.default.conf"
    dest: /etc/nginx/conf.d/99.default.conf
    remote_src: no

- name: Copy default index page
  copy:
    src: /var/lib/nginx/html/index.html
    dest: /srv/www/default/index.html
    owner: nginx
    group: nginx
    remote_src: yes

- name: Create Let's Encrypt challenge config
  copy:
    src: "files/letsencrypt.conf"
    dest: /etc/nginx/letsencrypt.conf
    remote_src: no

- name: Create sites configs (HTTP only)
  debug:
    msg: TODO

# - name: Create config for Letâ€™s Encrypt challenges
#   debug:
#     msg: TODO

- name: Start nginx
  service:
    name: nginx
    state: started
    runlevel: default

- name: Reload nginx config
  service:
    name: nginx
    state: reloaded

- name: Create SSL mountpoint
  file:
    path: /home/user-data/ssl
    state: directory

- name: Create SSL certs dir
  file:
    path: /etc/ssl/letsencrypt
    state: directory

- name: Copy copy-certs script
  copy:
    src: files/copy-certs.sh
    dest: /root/copy-certs.sh
    remote_src: no
    mode: 0700

- name: Create cron task for copy-certs
  cron:
    name: "Copy SSL certs"
    minute: "0"
    hour: "0,12"
    job: "bash /root/copy-certs.sh"

- name: Create SSL challenges dir
  file:
    path: /var/letsencrypt/docroot
    state: directory
...
